{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registro condominos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        .remove-block { cursor: pointer; color: #dc3545; }
        .error-msg { color: #dc3545; margin-bottom: 10px; }
    </style>
</head>
<body>
{% include 'loading_overlay.html' %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}

<div class="container mt-1">
    <h2 class="mb-3">Registro de Condóminos</h2>
    <button type="button" class="btn btn-ayuda mb-3" data-bs-toggle="modal" data-bs-target="#ayudaModal" style="color: red;">
        Ayuda Registro
    </button>
    <form method="post" id="registroForm">
        {% csrf_token %}
        <!-- Paso 1: Datos del usuario -->
        <div id="paso1">
            <div class='container mt-1 p-2' style="max-width: 500px;">
                <div id="errorPaso1" class="error-msg" style="display:none;"></div>
                <div class="mb-3">
                    <label>Nombre</label>
                    <input type="text" name="nombre" id="nombre" class="form-control w-100" required value="{{ nombre|default:'' }}">
                </div>
                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" name="email" id="email" class="form-control w-100" required value="{{ email|default:'' }}">
                </div>
                <div class="mb-3">
                    <label>Usuario</label>
                    <input type="text" name="username" id="username" class="form-control w-100" required value="{{ username|default:'' }}">
                </div>
                <div class="mb-3">
                    <label>Contraseña</label>
                    <input type="password" name="password" id="password" class="form-control w-100" required>
                    <small>La contraseña debe tener al menos 8 caracteres.</small>
                </div>
                <div class="mb-3">
                    <label>Confirmar Contraseña</label>
                    <input type="password" name="password2" id="password2" class="form-control w-100" required>
                </div>
                <button type="button" class="btn btn-primary mt-3 w-100" id="continuarBtn">Continuar</button>
            </div>
        </div>
        <!-- Paso 2: Empresas, Locales y Áreas -->
        <div id="paso2" style="display:none;">
            <div class='container-fluid mt-4 p-2' style="max-width: 800px;">
                <h2>Seleccion de Empresas, Locales y Áreas</h2>
                <div class="mb-3">
                    <small>Si tienes locales y/o áreas en más de una empresa, da clic en "Agregar Empresa".</small>
                <button type="button" class="btn btn-secondary" id="add-bloque">Agregar Empresa</button>
                <div id="bloques-container"></div>
                
                <button type="submit" class="btn btn-primary">Registrar Usuario</button>
                <button type="button" class="btn btn-outline-dark" id="regresarBtn">Regresar</button>
                {% comment %} <button type="reset" class="btn btn-warning">Limpiar</button> {% endcomment %}
                <button type="button" class="btn btn-danger" onclick="window.location.href='{% url 'visitante_logout' %}'">Salir</button>
                
            </div>
        </div>
    </form>
</div>

<script>
const empresasData = {{ empresas_json|safe }};
let bloqueIdx = 0;

function crearBloque(idx) {
    let empresaOptions = '<option value="">Seleccione empresa</option>';
    empresasData.forEach(e => {
        empresaOptions += `<option value="${e.id}">${e.nombre}</option>`;
    });

    return `
    <div class="card mb-3 bloque-empresa" data-idx="${idx}">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Empresa y asignaciones</strong>
                <span class="remove-block" onclick="removerBloque(${idx})">&times; Quitar</span>
            </div>
            <div class="mb-2">
                <label>Empresa</label>
                <select name="empresa_${idx}" class="form-select empresa-select" data-idx="${idx}" required>
                    ${empresaOptions}
                </select>
            </div>
            <div class="mb-2">
                <label>Locales</label>
                <select name="locales_${idx}" class="form-select locales-select" data-idx="${idx}" multiple>
                    <option value="">Seleccione empresa primero</option>
                </select>
            </div>
            <div class="mb-2">
                <label>Áreas</label>
                <select name="areas_${idx}" class="form-select areas-select" data-idx="${idx}" multiple>
                    <option value="">Seleccione empresa primero</option>
                </select>
            </div>
        </div>
    </div>
    `;
}

function actualizarLocalesAreas(idx, empresaId) {
    const empresa = empresasData.find(e => e.id == empresaId);
    const localesSelect = document.querySelector(`select[name="locales_${idx}"]`);
    const areasSelect = document.querySelector(`select[name="areas_${idx}"]`);
    if (localesSelect && areasSelect) {
        if (empresa) {
            localesSelect.innerHTML = empresa.locales.map(l => `<option value="${l.id}">${l.numero}</option>`).join('');
            areasSelect.innerHTML = empresa.areas.map(a => `<option value="${a.id}">${a.numero}</option>`).join('');
        } else {
            localesSelect.innerHTML = '<option value="">Seleccione empresa primero</option>';
            areasSelect.innerHTML = '<option value="">Seleccione empresa primero</option>';
        }
    }
}

function removerBloque(idx) {
    document.querySelector(`.bloque-empresa[data-idx="${idx}"]`).remove();
}

document.getElementById('add-bloque').addEventListener('click', function() {
    const idx = bloqueIdx;
    const container = document.getElementById('bloques-container');
    container.insertAdjacentHTML('beforeend', crearBloque(idx));
    const empresaSelect = document.querySelector(`select[name="empresa_${idx}"]`);
    empresaSelect.addEventListener('change', function() {
        actualizarLocalesAreas(idx, this.value);
    });
    bloqueIdx++;
});

// Mostrar paso 2 al dar clic en continuar, validando campos
document.getElementById('continuarBtn').onclick = function() {
    const nombre = document.getElementById('nombre').value.trim();
    const email = document.getElementById('email').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const password2 = document.getElementById('password2').value;
    const errorDiv = document.getElementById('errorPaso1');
    errorDiv.style.display = 'none';
    errorDiv.innerText = '';

    if (!nombre || !email || !username || !password || !password2) {
        errorDiv.innerText = 'Por favor llena todos los campos.';
        errorDiv.style.display = 'block';
        return;
    }
    // Validación de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        errorDiv.innerText = 'Por favor ingresa un correo electrónico válido.';
        errorDiv.style.display = 'block';
        return;
    }
    if (password.length < 8) {
        errorDiv.innerText = 'La contraseña debe tener al menos 8 caracteres.';
        errorDiv.style.display = 'block';
        return;
    }
    if (password !== password2) {
        errorDiv.innerText = 'Las contraseñas no coinciden.';
        errorDiv.style.display = 'block';
        return;
    }
    document.getElementById('paso1').style.display = 'none';
    document.getElementById('paso2').style.display = 'block';
    if (bloqueIdx === 0) {
        document.getElementById('add-bloque').click();
    }
};

// Botón regresar
document.getElementById('regresarBtn').onclick = function() {
    document.getElementById('paso2').style.display = 'none';
    document.getElementById('paso1').style.display = 'block';
};

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

<!-- Modal de ayuda -->
<div class="modal fade" id="ayudaModal" tabindex="-1" aria-labelledby="ayudaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ayudaModalLabel">Pasos para el registro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ol>
          <li>Ingresa tu nombre, correo y usuario.</li>
          <li>Elige una contraseña y confírmala.</li>
          <li>Si tienes locales y/o areas en mas de una empresa dar clic en botón agregar empresa.</li>
          <li>Luego selecciona los locales y/o áreas correspondientes a cada empresa seleccionada.</li>
          <li>Para eliminar una empresa dar clic en la palabra 'x Quitar'.</li>
          <li>Haz clic en "Registrar".</li>
          <li>Recibirás un correo de confirmación y el administrador validará tu registro.</li>
        </ol>
        <p>Si tienes dudas, contacta al administrador del sistema <a href="mailto:adminsoftheron@gesacadmin.com">aquí</a>.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>