{% load static %}
{% load humanize %}
{% load presupuesto_tags %}
{% load dict_extras %}
{% load get_range %}
<!DOCTYPE html>
<html lang="es">
<head>
    <!-- 
      Created by: Jaime Estrada
      Modified by: Mar칤a Mart칤nez
      Date of creation: 14/07/2025
      Date of modification: 12/09/2025
      Description: Budget matrix
    -->
    <meta charset="UTF-8">
    <title>Matriz presupuesto gastos</title>
    <!-- Bootstrap base styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Font Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet">
    <!-- Customised CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        input[type="number"] { min-width: 90px; text-align: right; }
        td, th { vertical-align: middle !important; }
        .table-info, .table-primary, .table-warning { font-weight: bold; }
        input[disabled] { background-color: #f0f0f0; color: #888; border-color: #ccc; }
    </style>
    <style>
.table-responsive {
    max-height: 70vh;
    overflow-y: auto;
}
.table-fixed-header thead th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
}
</style>
<style>
.btn-toggle-cruz i {
    color: #d32f2f !important;
    font-size: 1.6em !important;
    font-weight: bold !important;
    transition: transform 0.2s;
    vertical-align: middle;
}
</style>
</head>
<body>
    {% include 'navbar.html' %}
    {% include 'loading_overlay.html' %}
    
    <!-- Block for displaying messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
            {{ error }}
        {% endfor %}
        </div>
    {% endif %}
    {% if pedir_superuser and bloqueado %}
    <div class="alert-info mt-1">
       <button type="button" class="btn btn-danger" id="mostrar-form-superuser">
            Abrir presupuesto
       </button>

        <form method="post" class="row g-2 align-items-center mt-2" id="form-superuser" style="display:none;">
            {% csrf_token %}
            <div class="col-auto">
                <label for="superuser_username" class="form-label mb-0">Usuario:</label>
                <input type="text" name="superuser_username" id="superuser_username" class="form-control" required>
            </div>
            <div class="col-auto">
                <label for="superuser_password" class="form-label mb-0">Contrase침a:</label>
                <input type="password" name="superuser_password" id="superuser_password" class="form-control" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-danger">Confirmar apertura</button>
            </div>
        </form>
        <div class="mt-2"></div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var btn = document.getElementById('mostrar-form-superuser');
                var form = document.getElementById('form-superuser');
                btn.addEventListener('click', function() {
                    btn.style.display = 'none';
                    form.style.display = 'flex';
                });
            });
        </script>
    {% endif %}
    </div>

    <!-- Main content -->
        <!-- Formulario de filtros (GET) -->
         <div class="container-fluid mt-4">
        <form method="get" class="row g-2 mb-3">
            <h2>{{ empresa.nombre }}</h2>
            <h3>Matriz Presupuesto Gastos - A침o {{ anio }}</h3>
            
            
            <div class="col-auto">
                <label for="anio" class="form-check-inline"><strong>A침o:</strong></label>
                <select name="anio" id="anio" class="form-select d-inline-block" style="width:auto;" onchange="this.form.submit()">
                    {% for a in anios %}
                        <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
                <a href="{% url 'exportar_presupuesto_excel' %}?anio={{ anio }}{% if empresa %}&empresa={{ empresa.id }}{% endif %}" class="btn btn-success btn-sm ms-2">
                    <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
                </a>
                
            </div>
            
            {% if is_super %}
            <div class="col-auto">
                <label for="empresa" class="form-label">Empresa:</label>
                <select name="empresa" id="empresa" class="form-select d-inline-block" style="width:auto;" onchange="this.form.submit()">
                    {% for emp in empresas %}
                        <option value="{{ emp.id }}" {% if empresa.id == emp.id %}selected{% endif %}>{{ emp.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}   
        </form>

        <!-- Formulario para clonar presupuesto (POST, separado) -->
        <form method="post" action="{% url 'copiar_presupuesto_gastos_a_nuevo_anio' %}" class="row g-2 align-items-end mb-3">
            {% csrf_token %}
            <input type="hidden" name="empresa" value="{{ empresa.id }}">
            <input type="hidden" name="anio" value="{{ anio }}">
            <div class="col-auto">
                <label for="tipo_clon" class="form-label mb-0">Clonar:</label>
                <select name="tipo_clon" id="tipo_clon" class="form-select form-select-sm"
                    onchange="document.getElementById('porcentaje_clon').style.display = this.value == 'con' ? 'inline-block' : 'none';">
                    <option value="sin">Sin incremento</option>
                    <option value="con">Con incremento</option>
                    <option value="forecast">Forecast (tendencia)</option>
                </select>
            </div>
            <div class="col-auto" id="porcentaje_clon" style="display:none;">
                <label for="porcentaje" class="form-label mb-0">Porcentaje (%)</label>
                <input type="number" step="0.01" min="0" name="porcentaje" id="porcentaje" class="form-control form-control-sm" value="10">
            </div>
            <div class="col-auto">
                <button type="submit" 
                    class="btn text-dark ms-2"
                    style="background-color: #fff3cd; border: 1px solid #000; font-size: 0.875rem; padding: 0.25rem 0.5rem;"
                    onmouseover="this.style.backgroundColor='#ffca2c'; this.style.color='#000';"
                    onmouseout="this.style.backgroundColor='#fff3cd'; this.style.borderColor='#000'; this.style.color='#212529';">
                    <i class="bi bi-arrow-repeat"></i> Clonar presupuesto
                </button>
            </div> 
        </form>
        <div class="mb-3">
            {% if edicion_habilitada %}
                <form method="post" action="{% url 'borrar_presupuesto_gastos' %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="anio" value="{{ anio }}">
                <input type="hidden" name="empresa" value="{{ empresa.id }}">
                <button type="submit" class="btn btn-danger btn-sm"
                    onclick="return confirm('쯉eguro que deseas borrar TODO el presupuesto de gastos del a침o {{ anio }} para la empresa {{ empresa.nombre }}?');">
                    Borrar presupuesto
                </button>
                </form>
            {% endif %}
        </div>

        <!-- Main budget edit form (POST) -->
        <form method="post" id="form-matriz">
    {% csrf_token %}
    <input type="hidden" name="anio" value="{{ anio }}">
    {% if empresa %}
        <input type="hidden" name="empresa" value="{{ empresa.id }}">
    {% endif %}

    <div class="table-responsive rounded-3 border">
        <table class="table align-middle mb-0 shadow-sm table-fixed-header" id="matriz-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Grupo</th>
                    <th>Subgrupo</th>
                    <th>Tipo de Gasto</th>
                    {% for mes_nombre in meses_nombres %}
                        <th>{{ mes_nombre }}</th>
                    {% endfor %}
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for grupo in grupos %}
                    <tr class="table-primary grupo-row" data-grupo="{{ grupo.id }}">
                        <td>
                            <button type="button" class="btn btn-sm btn-link btn-toggle-cruz toggle-grupo" data-grupo="{{ grupo.id }}" title="Colapsar/Expandir grupo">
                                <i class="bi bi-dash-lg icon-abierto"></i>
                                <i class="bi bi-plus-lg icon-cerrado" style="display:none"></i>
                            </button>
                        </td>
                        <td><strong>{{ grupo.nombre }}</strong></td>
                        <td colspan="2"><strong>Total Grupo</strong></td>
                        {% for i in "0"|get_range:12 %}
                            <td>{{ grupo.subtotal|list_index:forloop.counter0|floatformat:2|intcomma }}</td>
                        {% endfor %}
                        <td class="fw-bold">{{ grupo.subtotal|sum_list|floatformat:2|intcomma }}</td>
                    </tr>
                    {% for subgrupo in grupo.subgrupos %}
                        <tr class="table-info subgrupo-row" data-grupo="{{ grupo.id }}" data-subgrupo="{{ subgrupo.id }}">
                            <td style="padding-left:2em;">
                                <button type="button" class="btn btn-sm btn-link btn-toggle-cruz toggle-subgrupo" data-subgrupo="{{ subgrupo.id }}" title="Colapsar/Expandir subgrupo">
                                    <i class="bi bi-dash-lg icon-abierto"></i>
                                    <i class="bi bi-plus-lg icon-cerrado" style="display:none"></i>
                                </button>
                            </td>
                            <td></td>
                            <td><strong>{{ subgrupo.nombre }}</strong></td>
                            <td><strong>Total Subgrupo</strong></td>
                            {% for i in "0"|get_range:12 %}
                                <td>{{ subgrupo.subtotal|list_index:forloop.counter0|floatformat:2|intcomma }}</td>
                            {% endfor %}
                            <td class="fw-bold">{{ subgrupo.subtotal|sum_list|floatformat:2|intcomma }}</td>
                        </tr>
                        {% for tipo in subgrupo.tipos %}
                            <tr class="tipo-row" data-grupo="{{ grupo.id }}" data-subgrupo="{{ subgrupo.id }}" data-tipo="{{ tipo.id }}">
                                <td style="padding-left:3em;">
                                    <button type="button" class="btn btn-sm btn-link btn-toggle-cruz toggle-tipo" data-tipo="{{ tipo.id }}" title="Colapsar/Expandir tipo">
                                        <i class="bi bi-dash-lg icon-abierto"></i>
                                        <i class="bi bi-plus-lg icon-cerrado" style="display:none"></i>
                                    </button>
                                </td>
                                <td></td>
                                <td></td>
                                <td>{{ tipo.nombre }}</td>
                                {% for i in "0"|get_range:12 %}
                                    {% with mes_num=i|add:1 %}
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                            name="presupuesto_{{ tipo.id }}_{{ mes_num }}"
                                            class="form-control form-control-sm presupuesto-input"
                                            value="{{ tipo.montos|dict_get:mes_num|floatformat:2 }}"
                                            data-tipo="{{ tipo.id }}" data-mes="{{ mes_num }}"
                                            {% if not edicion_habilitada or bloqueado %}disabled{% endif %}
                                            title="Editar monto de {{ tipo.nombre }} en {{ meses_nombres|list_index:i }}"
                                        >
                                    </td>
                                    {% endwith %}
                                {% endfor %}
                                <td class="fw-bold">{{ tipo.subtotal|sum_list|floatformat:2|intcomma }}</td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-warning">
                    <td colspan="4" class="text-end"><strong>Total General</strong></td>
                    {% for total in totales_mes %}
                        <td><strong>{{ total|floatformat:2|intcomma }}</strong></td>
                    {% endfor %}
                    <td><strong>{{ totales_mes|sum_list|floatformat:2|intcomma }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>

    {% if edicion_habilitada %}
        <div class="mb-3 mt-4 d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary" name="guardar_presupuesto" title="Guardar todos los cambios">
                <i class="bi bi-save me-1"></i> Guardar
            </button>
            {% if not bloqueado %}
                <button type="submit" name="cerrar_presupuesto"
                    class="btn text-dark"
                    style="background-color: #fff3cd; border: 1px solid #212529;"
                    onmouseover="this.style.backgroundColor='#ffca2c';"
                    onmouseout="this.style.backgroundColor='#fff3cd';"
                    onclick="return confirm('쮼st치s seguro de cerrar el presupuesto? No podr치s editarlo a menos que seas superusuario.')"
                    title="Cerrar presupuesto y bloquear edici칩n">
                    <i class="bi bi-file-lock-fill me-1"></i> Cerrar Presupuesto
                </button>
            {% endif %}
        </div>
    {% endif %}
</form>

    <!-- 游댳 Footer -->
    <footer class="mt-4">
        춸 {% now "Y" %} GESAC. Created By JMEB Todos los derechos reservados. <br>
    </footer>

    <!-- Scripts -->
    <script>
document.addEventListener('DOMContentLoaded', function() {
    var anioSelect = document.querySelector('select[name="anio"]');
    if (anioSelect) {
        anioSelect.addEventListener('change', function() {
            var overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
            // El formulario se enviar치 autom치ticamente si tienes onchange="this.form.submit()"
        });
    }
});
</script>
<script>
function toggleIcon(btn, collapsed) {
    var iconAbierto = btn.querySelector('.icon-abierto');
    var iconCerrado = btn.querySelector('.icon-cerrado');
    if (collapsed) {
        iconAbierto.style.display = 'none';
        iconCerrado.style.display = '';
    } else {
        iconAbierto.style.display = '';
        iconCerrado.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Grupos
    document.querySelectorAll('.toggle-grupo').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var grupoId = btn.dataset.grupo;
            var subgrupoRows = document.querySelectorAll('.subgrupo-row[data-grupo="' + grupoId + '"]');
            var tipoRows = document.querySelectorAll('.tipo-row[data-grupo="' + grupoId + '"]');
            var collapsed = btn.classList.toggle('collapsed');
            subgrupoRows.forEach(function(row) { row.style.display = collapsed ? 'none' : ''; });
            tipoRows.forEach(function(row) { row.style.display = collapsed ? 'none' : ''; });
            toggleIcon(btn, collapsed);
        });
    });
    // Subgrupos
    document.querySelectorAll('.toggle-subgrupo').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var subgrupoId = btn.dataset.subgrupo;
            var tipoRows = document.querySelectorAll('.tipo-row[data-subgrupo="' + subgrupoId + '"]');
            var collapsed = btn.classList.toggle('collapsed');
            tipoRows.forEach(function(row) { row.style.display = collapsed ? 'none' : ''; });
            toggleIcon(btn, collapsed);
        });
    });
    // Tipos
    document.querySelectorAll('.toggle-tipo').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var tipoId = btn.dataset.tipo;
            var tipoRow = document.querySelector('.tipo-row[data-tipo="' + tipoId + '"]');
            var collapsed = btn.classList.toggle('collapsed');
            tipoRow.style.display = collapsed ? 'none' : '';
            toggleIcon(btn, collapsed);
        });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.presupuesto-input').forEach(function(input) {
        input.addEventListener('change', function() {
            if (input.disabled) return;
            var tipoId = input.dataset.tipo;
            var mes = input.dataset.mes;
            var monto = input.value;
            var oldValue = input.getAttribute('data-old') || input.defaultValue;
            input.disabled = true;
            input.classList.remove('is-invalid', 'is-valid');
            fetch("{% url 'matriz_presupuesto' %}?anio={{ anio }}&empresa={{ empresa.id }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ tipo_id: tipoId, mes: mes, monto: monto }),
            })
            .then(response => response.json())
            .then(data => {
                input.disabled = false;
                if (data.success) {
                    input.classList.add('is-valid');
                    input.setAttribute('data-old', monto);
                } else {
                    input.classList.add('is-invalid');
                    input.value = oldValue;
                    alert("Error al guardar: " + (data.error || "Desconocido"));
                }
            })
            .catch(() => {
                input.disabled = false;
                input.classList.add('is-invalid');
                input.value = oldValue;
                alert("Error de red");
            });
        });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var formClon = document.querySelector('form[action*="copiar_presupuesto_gastos_a_nuevo_anio"]');
    if (formClon) {
        formClon.addEventListener('submit', function() {
            var overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'flex';
        });
    }
});
</script>
 <!-- Scripts -->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    var anioSelect = document.querySelector('select[name="anio"]');
    if (anioSelect) {
        anioSelect.addEventListener('change', function() {
            var overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
            // El formulario se enviar치 autom치ticamente si tienes onchange="this.form.submit()"
        });
    }
});
</script>

</body>
</html>