{% load humanize %}
{% load static %}
{% load dict_extras %}
<!DOCTYPE html>
<html lang="es">
<head>
    <title>comparativo ppto ingresos vs anio anterior</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    {% include 'navbar.html' %}
<div class="container mt-4">
  <h4>Comparativo Presupuestal Ingresos â€” {{ empresa.nombre }}</h4>

  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <label class="form-label">AÃ±o</label>
      <input type="number" name="anio" value="{{ anio }}" class="form-control" />
    </div>
    {% if request.user.is_superuser %}
    <div class="col-auto">
      <label class="form-label">Empresa (id)</label>
      <input type="text" name="empresa" value="{{ empresa.id }}" class="form-control" />
    </div>
    {% endif %}
    <div class="col-auto align-self-end">
      <button class="btn btn-primary">Actualizar</button>
      <a class="btn btn-outline-secondary" href="?anio={{ anio }}&export=excel">Exportar Excel</a>
    </div>
  </form>

  <table class="table table-sm table-striped">
    <thead class="table-dark">
      <tr>
        <th>Nivel</th><th>DescripciÃ³n</th>
        <th class="text-end">Total {{ anio_ant }}</th>
        <th class="text-end">Total {{ anio }}</th>
        <th class="text-end">Diferencia</th>
        <th class="text-end">% VariaciÃ³n</th>
      </tr>
    </thead>
    <tbody>
      <tr class="table-secondary">
        <td><strong>GLOBAL</strong></td>
        <td><strong>Total anual</strong></td>
        <td class="text-end">${{ total_anterior|floatformat:0|intcomma }}</td>
        <td class="text-end"><strong>${{ total_actual|floatformat:0|intcomma }}</strong></td>
        <td class="text-end">${{ diferencia_total|floatformat:0|intcomma }}</td>
        <td class="text-end">
          {% if pct_total is not None %}
            {% if pct_total > 0 %}+{% endif %}{{ pct_total|floatformat:0|intcomma }} %
          {% else %}
            N/A
          {% endif %}
        </td>
      </tr>

      {% for o in origenes %}
        <tr class="table-primary">
          <td><strong>ORIGEN</strong></td>
          <td><strong>{{ origen_labels|lookup:o.origen|default:o.origen|capfirst }}</strong></td>
          <td class="text-end">${{ o.tot_anterior|floatformat:0|intcomma }}</td>
          <td class="text-end"><strong>${{ o.tot_actual|floatformat:0|intcomma }}</strong></td>
          <td class="text-end">${{ o.diferencia|floatformat:0|intcomma }}</td>
          <td class="text-end">
            {% if o.pct is not None %}
              {% if o.pct > 0 %}+{% endif %}{{ o.pct|floatformat:0|intcomma }} %
            {% else %}
              N/A
            {% endif %}
          </td>
        </tr>

        {% for t in o.tipos %}
          {% with tipo_display=tipo_cuota_map|lookup:t.tipo|default:t.tipo %}
          <tr class="table-light">
            <td style="padding-left:20px;">TIPO</td>
            <td style="padding-left:20px;">{{ tipo_display }}</td>
            <td class="text-end">${{ t.anterior|floatformat:0|intcomma }}</td>
            <td class="text-end">${{ t.actual|floatformat:0|intcomma }}</td>
            <td class="text-end">${{ t.diferencia|floatformat:0|intcomma }}</td>
            <td class="text-end">
              {% if t.pct is not None %}
                {% if t.pct > 0 %}+{% endif %}{{ t.pct|floatformat:0|intcomma }} %
              {% else %}
                N/A
              {% endif %}
            </td>
          </tr>
          {% endwith %}
        {% endfor %}
      {% endfor %}

    </tbody>
  </table>
</div>
<!-- ðŸ”¹ Footer -->
    <footer>
        Â© {% now "Y" %} GESAC. Todos los derechos reservados. <br>
        Creado por JMEB
    </footer>

    <!-- Scripts -->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>