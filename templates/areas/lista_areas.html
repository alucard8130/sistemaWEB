{% load static %} {% load humanize %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- 
      Created by: Jaime Estrada
      Modified by: Mar칤a Mart칤nez
      Date of creation: 05/06/2025
      Date of modification: 28/08/2025
      Description: List of registered common areas
    -->
    <meta charset="UTF-8" />
    <title>Lista 치reas</title>
    <!-- Bootstrap base styles -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Google Font Rubik -->
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik&display=swap"
      rel="stylesheet"
    />
    <!-- Customised CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    {% include 'navbar.html' %}
    {% include 'loading_overlay.html' %}
    <!-- Block for displaying messages -->
      {% if messages %} {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %} {% endif %}
      {% if error %}
          <div class="alert alert-danger text-center">{{ error }}</div>
      {% endif %}

    <!-- Main content -->
    <div class="container-fluid mt-2">
<!-- Tarjeta informativa fija arriba de la tabla, centrada y con ancho limitado -->
<div class="mb-2 d-flex justify-content-left mt-2" style="gap: 15px; flex-wrap: wrap;">
  <div class="card shadow-lg border-primary" style="max-width: 410px; width: 100%; max-height: 200px; font-size: 13px;">
    <div class="card-header bg-primary text-white">
      <i class="bi bi-bar-chart-fill me-2"></i>Indicadores KPIs 
    </div>
    <div class="card-body"> 
      <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between">
          <span>Areas Comunes:</span>
          <strong>{{ total_areas }}</strong>
        </li>   
        <li class="list-group-item d-flex justify-content-between">
          <span> Total Cuotas mensuales:</span>
          <strong>${{ total_cuotas|floatformat:2|intcomma }}</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Promedio Cuotas:</span>
          <strong>${{ promedio_cuotas|floatformat:2|intcomma }}</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Promedio Precio x m:</span>
          <strong>${{ promedio_precio_m2|floatformat:2|intcomma }}</strong>
        </li>
      </ul>
    </div>
  </div>
{% comment %} </div> {% endcomment %}
{% comment %} <div class="mb-1 d-flex justify-content-left"> {% endcomment %}
  <div class="card shadow-lg border-primary" style="max-width: 410px; width: 100%; max-height: 200px; font-size: 13px;">
    <div class="card-header bg-primary text-white">
      <i class="bi bi-bar-chart-fill me-2"></i>KPIs Superficie 
    </div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
      
        <li class="list-group-item d-flex justify-content-between">
          <span>Total Superficie (GLA):</span>
          <strong>{{ superficie_total|floatformat:2|intcomma }} m</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span> Contratos Vigentes:</span>
          <strong>{{ status_vigente}}</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Contratos Vencidos:</span>
          <strong>{{ status_vencido}}</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Porcentaje Vencido:</span>
          <strong>{{ porcentaje_vencido|floatformat:0|intcomma }}%</strong>
        </li>
      </ul>
    </div>
  </div>
</div>
      <form id="form-filtros" method="get" class="mb-3 d-flex" role="search">
        <input
          type="text"
          name="q"
          class="form-control me-2"
          placeholder="Buscar 치rea por n칰mero o cliente"
          value="{{ q|default:'' }}"
        />
        <button type="submit" class="btn btn-outline-primary">Buscar</button>
      </form>
      <!-- Area table -->
      <div class="table-responsive rounded-3 border" style="font-size:0.9rem;">
        <table class="table align-middle mb-0 shadow-sm">
          <thead>
            <tr>
              <th>N칰mero</th>
              <th>Cliente</th>
              {% if request.user.is_superuser %}
              <th>Empresa</th>
              {% endif %}
              <th>Superficie</th>
              {% comment %} <th>Ubicaci칩n</th> {% endcomment %}
              <th>Cuota</th>
              <th>Anual</th>
              <th>Dep칩sito</th>
              <th>Giro</th>
              <th>Tipo</th>
              <th>Fecha Ini</th>
              <th>Fecha Fin</th>
              <th>Vigencia</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for area in areas %}
            <tr>
              <td>{{ area.numero }}</td>
              <td>{{ area.cliente.nombre }}</td>
              {% if request.user.is_superuser %}
              <td>{{ area.empresa.nombre }}</td>
              {% endif %}
              <td>{{ area.superficie_m2|floatformat:2|intcomma }}</td>
              {% comment %} <td>{% if area.ubicacion %}{{ area.ubicacion }}{% endif %}</td> {% endcomment %}
              <td>${{ area.cuota|floatformat:2|intcomma }}</td>
              <td>
                  {% if area.es_cuota_anual %}
                      <span class="badge bg-info">Si</span>
                  {% else %}
                      <span class="badge bg-success"></span>
                  {% endif %}
              </td>
              <td>${{ area.deposito|floatformat:2|intcomma }}</td>
              <td>{{ area.giro }}</td>
              <td>{{ area.tipo_area }}</td>
              <td>{{ area.fecha_inicial|date:"d/b/y"|upper }}</td>
              <td>{{ area.fecha_fin|date:"d/b/y"|upper }}</td>
              <td>
                {% if area.estado_vigencia == "Vencido" %}
                <span class="badge bg-danger" title="Edita Fechas para Renovar Contrato">{{ area.estado_vigencia }}</span>
                {% else %}
                <span class="badge bg-success">{{ area.estado_vigencia }}</span>
                {% endif %}
              </td>
              <td style="white-space: nowrap">
                 <a
                  href="{% url 'lista_facturas' %}?area_id={{ area.id }}"
                  class="btn btn-outline-primary btn-sm reporte-link"
                  title="Registrar pagos"
                >
                  Adeudos
                  <i class="bi bi-receipt"></i>
                </a>
                {% if area.estado_vigencia == "Vigente" %}
                 <a href="{% url 'contrato_formulario' area.pk %}" class="btn btn-sm btn-primary m-1" {% if area.empresa and area.empresa.es_plus %} target="_blank" {% endif %}  title="ver Contrato">  
                Contrato
                  <i class="bi bi-file-earmark-text"></i>
                </a>
                {% else %}
                <spam class="btn btn-sm btn-secondary m-1" title="Contrato no disponible">
                  Contrato
                  <i class="bi bi-file-earmark-text"></i>
                </spam>
                {% endif %}
                <a
                  href="{% url 'editar_area' area.pk %}"
                  class="btn btn-sm btn-outline-primary me-1 reporte-link"
                  title="Editar"
                >
                  <i class="bi bi-pencil-square"></i>
                </a>
                <a
                  href="{% url 'eliminar_area' area.pk %}"
                  class="btn btn-sm btn-outline-danger reporte-link"
                  title="Inactivar"
                >
                  <i class="bi bi-slash-circle"></i>
              </a>
                <!-- Button to assign client if area is available -->
                {% if area.status == 'disponible' %}
                <a
                  href="{% url 'asignar_cliente' area.pk %}"
                  class="btn btn-outline-success btn-sm reporte-link"
                  title="Asignar cliente"
                >
                  <i class="bi bi-person-plus"></i>
                </a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr class="no-data-row">
              <td colspan="9">No hay 치reas registradas.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <nav aria-label="Paginaci칩n">
  <ul class="pagination">
    {% if areas.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?q={{ q }}&page={{ areas.previous_page_number }}">Anterior</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">P치gina {{ areas.number }} de {{ areas.paginator.num_pages }}</span></li>
    {% if areas.has_next %}
      <li class="page-item">
        <a class="page-link" href="?q={{ q }}&page={{ areas.next_page_number }}">Siguiente</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
    {% endif %}
  </ul>
</nav>
      </div>
    </div>

    <!-- 游댳 Footer -->
    <footer>
      춸 {% now "Y" %} GESAC. Created By JMEB Todos los derechos reservados. <br />
    </footer>

    <!-- Scripts -->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
     <script>
document.addEventListener('DOMContentLoaded', function() {
  // Mostrar overlay al hacer submit en el formulario de filtros
  var form = document.getElementById('form-filtros');
  if (form) {
    form.addEventListener('submit', function() {
      var overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'flex';
    });
  }

  // Mant칠n el overlay para los enlaces con clase reporte-link
  document.querySelectorAll('a.reporte-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      var overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'flex';
    });
  });
});
</script>
  </body>
</html>
