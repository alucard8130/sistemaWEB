<!-- filepath: informes_financieros/templates/informes_financieros/ingresos_vs_gastos.html -->
{% load humanize %}
{%load custom_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <title>Ingresos vs Gastos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
<h2>Ingresos  vs Gastos </h2>
<form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-auto">
    {% if request.user.is_superuser %}
        <select name="empresa" class="form-select" style="width:auto;">
            <option value="">Todas las empresas</option>
            {% for emp in empresas %}
                <option value="{{ emp.id }}" {% if emp.id|stringformat:"s" == empresa_id %}selected{% endif %}>{{ emp.nombre }}</option>
            {% endfor %}
        </select>
    {% endif %}
    </div>
    <div class="col-auto">
        <button type="submit" name="periodo" value="mes_actual" class="btn btn-outline-primary"
            {% if periodo == 'mes_actual' %}disabled{% endif %}>Mes actual</button>
        <button type="submit" name="periodo" value="periodo_actual" class="btn btn-outline-primary"
            {% if periodo == 'periodo_actual' %}disabled{% endif %}>Periodo actual</button>
    </div>
    <div class="col-auto">
        <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
    </div>
    <div class="col-auto">
        <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filtrar periodo</button>
    </div>
    <div>
    <a href="{% url 'bienvenida' %}" class="btn btn-secondary">Regresar</a>
    </div>
</form>
{% if mes_letra %}
    <div class="alert alert-info mb-2">
        <strong>Periodo:</strong> {{ mes_letra }}
    </div>
{% endif %}
<div class="row">
    <div class="col-md-8">
        <canvas id="chartIngresosGastos"></canvas>
    </div>
    <div class="col-md-4">
        <ul class="list-group">
            {% for origen, monto in ingresos_por_origen.items %}
                <li class="list-group-item">
                    Ingresos {{ origen|capfirst }}: <strong>${{ monto|floatformat:2|intcomma }}</strong>
                </li>
            {% endfor %}
            <li class="list-group-item">Total Gastos: <strong>${{ total_gastos|floatformat:2|intcomma }}</strong></li>
        </ul>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = [{% for origen in ingresos_por_origen.keys %}'{{ origen|capfirst }}',{% endfor %}'Gastos'];
const ingresosData = [{% for monto in ingresos_por_origen.values %}{{ monto }},{% endfor %}0];
const gastosData = [{% for _ in ingresos_por_origen %}0,{% endfor %}{{ total_gastos }}];

const ctx = document.getElementById('chartIngresosGastos');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Ingresos',
                data: ingresosData,
                backgroundColor: '#198754'
            },
            {
                label: 'Gastos',
                data: gastosData,
                backgroundColor: '#dc3545'
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString('es-MX');
                    }
                }
            }
        }
    }
});
</script>
</div>
</body>
</html>