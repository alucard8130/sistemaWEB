{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <!-- 
        Created by: Jaime Estrada
        Modified by: María Martínez
        Date of creation: 05/06/2025
        Date of modification: 12/09/2025
        Description: Dashboard of balances by maturity
    -->
    <meta charset="UTF-8">
    <title>Dashboard Ingresos</title>
    <!-- Bootstrap base styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Font Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet">
    <!-- Customised CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% include 'navbar.html' %}
{% include 'loading_overlay.html' %}
    
<div class="container-fluid mt-4">
        <h2>Dashboard Ingresos - Año {{ anio_seleccionado }}</h2>
    <!-- Filtros de Pagos -->
    <form id="form-filtros" method="get" class="row g-2 mb-2 align-items-end">
        {% if es_super %}
        <div class="col-md-2">
            <label class="form-label mb-1">Empresa:</label>
            <select name="empresa" class="form-select">
                <option value="todas" {% if not empresa_id or empresa_id == "todas" %}selected{% endif %}>Todas</option>
                {% for emp in empresas %}
                    <option value="{{ emp.id }}" {% if emp.id|stringformat:"s" == empresa_id|stringformat:"s" %}selected{% endif %}>{{ emp.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="col-md-2">
            <label>Cuotas:</label>
            <select name="origen" class="form-select reporte-link">
                <option value="">Todas</option>
                <option value="local" {% if origen == "local" %}selected{% endif %}>Solo locales</option>
                <option value="area" {% if origen == "area" %}selected{% endif %}>Solo áreas comunes</option>
                <option value="otros" {% if origen == "otros" %}selected{% endif %}>Otros ingresos</option>
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label mb-1">Año:</label>
                <select name="anio" class="form-select reporte-link">  
                        {% for a in labels_anios %}
                            <option value="{{ a }}" {% if a|stringformat:"s" == anio_seleccionado|stringformat:"s" %}selected{% endif %}>
                                {{ a }}
                            </option>
                        {% endfor %}
                </select>
        </div>

        <div class="col-md-2">
            <label class="form-label mb-1">Mes:</label>
            <select name="mes" class="form-select reporte-link">
                <option value="">Todos</option>
                <option value="1" {% if mes == "1" %}selected{% endif %}>Enero</option>
                <option value="2" {% if mes == "2" %}selected{% endif %}>Febrero</option>
                <option value="3" {% if mes == "3" %}selected{% endif %}>Marzo</option>
                <option value="4" {% if mes == "4" %}selected{% endif %}>Abril</option>
                <option value="5" {% if mes == "5" %}selected{% endif %}>Mayo</option>
                <option value="6" {% if mes == "6" %}selected{% endif %}>Junio</option>
                <option value="7" {% if mes == "7" %}selected{% endif %}>Julio</option>
                <option value="8" {% if mes == "8" %}selected{% endif %}>Agosto</option>
                <option value="9" {% if mes == "9" %}selected{% endif %}>Septiembre</option>
                <option value="10" {% if mes == "10" %}selected{% endif %}>Octubre</option>
                <option value="11" {% if mes == "11" %}selected{% endif %}>Noviembre</option>
                <option value="12" {% if mes == "12" %}selected{% endif %}>Diciembre</option>
            </select>
        </div>
        
        <!-- Columna de botones: fila horizontal, alineada abajo -->
        <div class="col-md-2 align-self-end">
            <div class="d-flex gap-2">
                <!-- Botón Filtrar -->
                <button type="submit" class="btn btn-outline-primary d-inline-flex align-items-center">
                    <i class="bi bi-funnel me-1"></i> Filtrar
                </button>

                <!-- Botón Limpiar -->
                <a href="{% url 'dashboard_pagos' %}" class="btn btn-outline-secondary d-inline-flex align-items-center reporte-link">
                    <i class="bi bi-arrow-clockwise"></i> Limpiar
                </a>
            </div>
        </div>
    </form>

    <div class="row g-3">
    <div class="col-12">
        <div class="card shadow p-3">
            <h5 class="mb-2">Cuotas</h5>
            <canvas id="graficoPagosMes" style="min-height:350px; height:50vh; width:100%"></canvas>
        </div>
    </div>
</div>
    <script>
    // Pagos por Mes
const ctxPagosMes = document.getElementById('graficoPagosMes');
const otrosTiposTooltip = {{ otros_tipos_tooltip|safe }};
new Chart(ctxPagosMes, {
    data: {
        //labels: {{ meses|safe }},
        labels: [{% for l in labels_meses %}'{{ l }}',{% endfor %}],
        datasets: [
            {
                type: 'bar',
                label: 'Ingresos Cuotas',
                data: [{% for d in data_cuotas %}{{ d }},{% endfor %}],
                backgroundColor: '#66FF66',
                borderWidth: 1,
                order:2
                
            },
            {
                type: 'bar',
                label: 'Otros ingresos',
                data: [{% for d in data_otros %}{{ d }},{% endfor %}],
                backgroundColor: '#FF9900',
                borderWidth: 1,
                order:2
                
            },
            {
                label: 'Cuentas por cobrar',
                type: 'line',
                data: [{% for d in data_por_cobrar %}{{ d }},{% endfor %}],
                borderColor: '#9933FF',
                backgroundColor: 'rgba(153,51,255,0.2)',
                borderWidth: 3,
                fill: false,
                pointRadius: 4,
                tension: 0.2,
                order: 1
            
            },
            {
                label: 'Presupuesto',
                type: 'line',
                data: [{% for d in data_presupuesto %}{{ d }},{% endfor %}],
                borderColor: '#000000',
                backgroundColor: 'rgba(255,193,7,0.2)',
                borderWidth: 3,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 4,
                tension: 0.2,
                pointBackgroundColor: 'rgba(255,193,7,0.2)',
                order: 1
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true },
            title: { display: true,
            text: 'Ingresos Mensuales Vs Presupuesto' },
             tooltip: {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                    if (context.dataset.label === 'Otros ingresos') {
                        const idx = context.dataIndex;
                        const detalles = otrosTiposTooltip[idx];
                        if (detalles && detalles.length) {
                            label += '\n' + detalles.join('\n');
                        }
                    }
                    return label;
                }
            }
        }
        },
        scales: {
            x: { stacked: true },
            y: { stacked: true }
        }
    }
});

    </script>
</div>
    <footer>
        © {% now "Y" %} GESAC. Created By JMEB Todos los derechos reservados. <br>
    </footer>
    <script src="{% static 'js/script.js' %}"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
document.addEventListener('DOMContentLoaded', function() {
  // Mostrar overlay al hacer submit en el formulario de filtros
  var form = document.getElementById('form-filtros');
  if (form) {
    form.addEventListener('submit', function() {
      var overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'flex';
    });
  }

  // Mantén el overlay para los enlaces con clase reporte-link
  document.querySelectorAll('a.reporte-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      var overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'flex';
    });
  });
});
</script>
</body>
</html>
